name: Traffic Analytics Data Collection

on:
  schedule: 
    # Runs once a week on Sunday at 23:55 UTC
    - cron: '55 23 * * 0'
  workflow_dispatch:
    # Allows manual triggering from the Actions tab

permissions:
  contents: write

jobs:
  update-traffic-data:
    runs-on: ubuntu-latest

    steps:
    # Checkout the traffic-analysis branch (not main)
    - uses: actions/checkout@v4
      with:
        ref: traffic-analysis
        persist-credentials: true
    
    # Prepare existing CSV files for the action to append to
    - name: Setup traffic directory with existing data
      run: |
        mkdir -p traffic
        # Copy existing CSV files if they exist (so action can append)
        if [ -f data/views.csv ]; then
          cp data/views.csv traffic/views.csv
        fi
        if [ -f data/clones.csv ]; then
          cp data/clones.csv traffic/clones.csv
        fi
    
    # Collect traffic and clone data from GitHub API (appends to existing CSVs)
    - name: GitHub traffic collection
      uses: innovyze/repository-traffic-action@v0.1.8
      env:
        REPOSITORY_NAME: innovyze/Open-Source-Support
        TRAFFIC_ACTION_TOKEN: ${{ secrets.TRAFFIC_ACTION_TOKEN }}
    
    # Move updated data files back to data directory
    - name: Move updated data files to data folder
      run: |
        # Move the updated files from traffic/ to data/
        if [ -f traffic/views.csv ]; then
          mv traffic/views.csv data/views.csv
        fi
        if [ -f traffic/clones.csv ]; then
          mv traffic/clones.csv data/clones.csv
        fi
        # Clean up traffic directory
        rm -rf traffic
     
    # Commit changes back to the traffic-analysis branch
    - name: Commit changes to traffic-analysis branch
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add data/*.csv
        git commit -m "auto: update traffic data [skip ci]" || echo "No changes to commit"
        git push

