name: Traffic Data Collection

on:
  schedule: 
    # runs once a week on sunday
    - cron: '55 23 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  traffic:
    runs-on: ubuntu-latest

    steps:
    # Check out the traffic-analysis branch where dashboard lives
    - uses: actions/checkout@v4
      with:
        ref: traffic-analysis

    # Prepare existing CSV files for the action to read and append to
    - name: Setup traffic directory with existing data
      run: |
        mkdir -p traffic
        # Copy existing CSV files so action can append new data
        if [ -f data/views.csv ]; then
          cp data/views.csv traffic/views.csv
        fi
        if [ -f data/clones.csv ]; then
          cp data/clones.csv traffic/clones.csv
        fi

    # Calculates traffic and clones and appends to CSV files
    - name: GitHub traffic
      uses: innovyze/repository-traffic-action@v0.1.8
      env:
        REPOSITORY_NAME: innovyze/Open-Source-Support
        TRAFFIC_ACTION_TOKEN: ${{ secrets.TRAFFIC_ACTION_TOKEN }}

    # Move updated files back to data directory
    - name: Move data files
      run: |
        if [ -f traffic/views.csv ]; then
          mv traffic/views.csv data/views.csv
        fi
        if [ -f traffic/clones.csv ]; then
          mv traffic/clones.csv data/clones.csv
        fi
        # Remove empty traffic directory
        if [ -d traffic ] && [ -z "$(ls -A traffic)" ]; then
          rmdir traffic
        fi

    # Commits files to traffic-analysis branch
    - name: Commit changes
      uses: EndBug/add-and-commit@v9
      with:
        message: 'Update traffic data [automated]'
        add: 'data/*.csv'
        default_author: github_actions

