# InfoWorks ICM SQL Context Guide for LLM Agents

Original generated by AI **Last Updated:** October 15, 2025

## Overview
InfoWorks ICM (and InfoAsset Manager) implements a **proprietary subset of SQL** specifically designed for hydraulic network modeling and asset management. This is **NOT standard ANSI SQL** - it has unique syntax, operators, and capabilities tailored for spatial network operations, simulation results, and hydraulic modeling workflows.

This guide applies to:
- InfoWorks ICM (both InfoWorks and SWMM network types)
- InfoAsset Manager
- InfoWorks WS Pro (with some variations)

The core SQL syntax and rules are consistent across these products.

## Critical Differences from Standard SQL

### 1. **Object-Oriented Nature**
InfoWorks ICM SQL operates on **network objects** (nodes, links, subcatchments, etc.) rather than traditional database tables.

```sql
// SQL queries MUST specify target object type and spatial context
//Object: Conduit
//Spatial Search: blank
```

**Key Points:**
- Every SQL query requires an object type declaration (comment at top)
- Object types include: `Conduit`, `Node`, `Subcatchment`, `Pump`, `Weir`, `Orifice`, `River Reach`, `Polygon`, etc.
- Spatial search can be: `blank`, `Distance`, `Contains`, `Cross`, `Intersects`

### 2. **Variable Declaration and Types**

Variables use `$` prefix and are declared with `LET` or through `SELECT INTO`:

```sql
LET $distance = 50;                    // Integer
LET $x_us = 0.0;                      // Float
LIST $oids STRING;                     // String list
LIST $Surcharge = 0.0, 0.3, 0.5;      // Numeric list
```

**Variable Type Rules:**
- `LET` assigns values to scalar variables
- `LIST` declares list/array variables with explicit type (`STRING`, numeric)
- `SELECT ... INTO $variable` extracts data into variables
- Variables are **case-sensitive**
- Use `AREF($index, $list)` to access list elements (1-indexed)
- Use `LEN($list)` to get list length

### 3. **No CASE Statement - Use IF/ELSEIF/ELSE**

InfoWorks ICM SQL does **NOT support CASE statements**. Use IF blocks instead:

```sql
// WRONG - CASE not supported
CASE WHEN width = 600 THEN 500 END

// CORRECT - Use IF/ELSEIF/ELSE
IF $width = 600;
    SET conduit_width = 500 WHERE oid = AREF($i,$oids);
ELSEIF $width = 500;
    SET conduit_width = 400 WHERE oid = AREF($i,$oids);
ELSE;
    SET conduit_width = 100 WHERE oid = AREF($i,$oids);
ENDIF;
```

**Important:**
- Each clause ends with semicolon: `IF condition;`, `ELSEIF condition;`, `ELSE;`, `ENDIF;`
- Nested IF blocks are supported
- For inline conditionals, use `IIF(condition, true_value, false_value)`

### 4. **IIF Function (Inline IF)**

InfoWorks ICM uses `IIF()` for inline conditional logic:

```sql
// Conditional string concatenation
SET user_text_1 = user_text_1 + IIF(LEN(user_text_1)=0, '', ',') + oid;

// Conditional value selection
SET $avg = IIF($avg2 > $avg, $avg2, $avg);

// Nested IIF for complex logic
SUM(IIF(area_measurement_type = 'Percent', 
    (area_percent_1 / 100.0) * contributing_area, 
    area_absolute_1)) AS Runoff_Area_1
```

### 5. **Network Navigation via Dot Notation**

Access related objects using dot notation:

```sql
// Navigate from node to connected links
SET us_links.$link_selected = 1 WHERE $node_selected = 1;

// Navigate from link to nodes
UPDATE [All Links] SET us_node.$node_selected = 1 WHERE $link_selected = 1;

// Navigate through multiple levels
SELECT node_id INTO $linkid WHERE ds_links.$selected = 1;

// Access related object properties
SELECT ds_links.shape INTO $shp WHERE node_id = $linkid;
```

**Navigation Keywords:**
- `us_node`, `ds_node` - Upstream/downstream nodes from a link
- `us_links`, `ds_links` - Links connected to a node
- `all_us_links`, `all_ds_links` - All upstream/downstream links (entire network)
- `spatial.field` - Access spatially related objects
- `node.field` - Access node properties from subcatchment
- `cctv_surveys.field` - Access CCTV survey data from pipe (InfoAsset Manager only)
- `details.field` - Access blob table details (InfoAsset Manager only - observations, defects, etc.)

### 6. **Blob Tables (Nested/Child Tables)**

InfoWorks ICM supports hierarchical data structures via blob tables:

```sql
// Access nested table data
SELECT Min(sections.z) FROM [River Reach]
GROUP BY oid, sections.key;

// Insert into blob table
INSERT INTO [Head Discharge].HDP_table 
    (head_discharge_id, HDP_table.head, HDP_table.discharge) 
SELECT asset_id, user_number_3, user_number_4 
FROM Pump WHERE user_text_1 = 1;

// Delete from blob table
DELETE ALL FROM [Head discharge].HDP_table;

// Insert into subcatchment blob table
INSERT INTO subcatchment.suds_controls 
    (subcatchment_id, suds_controls.suds_structure, suds_controls.id)
SELECT oid, $SS, $SID FROM Subcatchment;
```

**Blob Table Rules:**
- Access with dot notation: `parent_table.blob_table.field`
- Common blob tables in ICM: `HDP_table`, `sections`, `suds_controls`, `land_uses_table`
- Common blob tables in InfoAsset: `details` (CCTV/MHS observations), defect tables
- Can aggregate blob table fields: `MIN()`, `MAX()`, `AVG()`, `SUM()`, `COUNT()`
- Filter by blob table content: `WHERE count(details.code) = 0`
- Select based on blob table values: `WHERE details.code = 'CC'`

### 7. **Spatial Queries**

Spatial operations:

```sql
// Spatial search setup
//Spatial Search: Distance Network [River reach] 100

// Or programmatically:
SPATIAL Distance Network [River reach] 100;
SELECT FROM [All Nodes] WHERE spatial.user_number_1 = 1;

// Clear spatial search
SPATIAL NONE;

// Other spatial operators
//Spatial Search: Contains, Network layer, All Nodes
//Spatial Search: Cross, Network layer, Conduit
//Spatial Search: Intersects, Network layer, Polygon
```

**Spatial Contexts:**
- `Distance` - Within specified distance
- `Contains` - Spatial containment
- `Cross` - Crossing/intersecting
- `Intersects` - Geometric intersection
- `SPATIAL NONE` - Clear spatial filter

### 8. **Selection Management**

Selection is a first-class concept:

```sql
// Update selection flags
UPDATE SELECTED [ALL LINKS] SET $selected = 1;
UPDATE [ALL Links] SET $link_selected = 0;

// Select objects
SELECT FROM [All Links] WHERE $link_selected = 1;
SELECT ALL FROM [All Nodes];

// Clear selection
DESELECT ALL;
CLEAR SELECTION;

// Maintain selection while selecting
SPATIAL NONE;
SELECT ALL FROM [All Nodes];  // Maintains river reach selection
```

### 9. **Scenario Operations**

Work across different scenarios:

```sql
// Copy data between scenarios
UPDATE [All Links] IN BASE SCENARIO SET $column = user_number_1;
UPDATE [All Links] IN SCENARIO 'test' SET user_number_1 = $column;
```

### 10. **Results Access**

Access simulation results via special prefixes:

```sql
// Time series results
SELECT oid, WHENMAX(tsr.ds_depth), WHENMAX(tsr.ds_flow);

// Results with conditions
SET $speed = AVG(IIF((tsr.timestep_no > $left) AND (tsr.timestep_no < $right), 
                     tsr.us_vel, NULL));

// Max timestep
UPDATE [All Links] SET $left = $start*MAX(tsr.timesteps)/$n_hours;

// Simulation results
SELECT us_node_id, ds_node_id, sim.max_Surcharge 
WHERE sim.max_Surcharge >= $SurchargeSelection;
```

**Results Prefixes:**
- `tsr.` - Time series results (depth, flow, velocity, etc.)
- `sim.` - Simulation summary results (max values, etc.)
- `WHENMAX()` - Returns timestep when maximum occurred

### 11. **Looping Constructs**

```sql
// WHILE loop (most common)
LET $i = 1;
WHILE $i <= LEN($oids);
    // Loop body
    LET $i = $i + 1;
WEND;

// Condition-based while
WHILE $chainage < $length;
    // Loop body
    LET $chainage = $chainage + $distance;
WEND;
```

**Loop Rules:**
- Use `WHILE condition;` and end with `WEND;`
- No FOR loops - use WHILE with counters
- Lists are **1-indexed** (not 0-indexed)
- Must manually increment counters

### 12. **INSERT Operations**

Create new objects dynamically:

```sql
// Insert node
INSERT INTO node (node_id, x, y, system_type, ground_level, flood_type) 
VALUES ($us_nodeid+"_"+$chainage, $new_x, $new_y, $sys, $gl, "sealed");

// Insert conduit
INSERT INTO conduit (us_node_id, ds_node_id, link_suffix, system_type) 
VALUES ($us_nodeid+"_"+$chainage, $dslinkid, 1, $sys);

// Insert with SELECT
INSERT INTO [Head Discharge] (head_discharge_id) 
SELECT SELECTED asset_id FROM Pump;
```

### 13. **UPDATE vs SET**

Both UPDATE and SET modify data, but with different syntax:

```sql
// SET - shorthand for UPDATE on current object type
SET user_text_1 = "" WHERE node_type = "outfall";

// UPDATE - explicit table reference
UPDATE Node SET user_text_1 = '';
UPDATE [All Links] SET $link_selected = 0;

// SET with navigation
SET ds_node.user_text_1 = ds_node.user_text_1 + oid;
```

### 14. **Aggregation Functions**

Standard aggregates work but often in unique contexts:

```sql
// Standard aggregation
SELECT SUM(contributing_area), COUNT(*) GROUP BY system_type;

// With DP (Decimal Places) formatting
SELECT Min(Min(sections.z)) DP 3 GROUP BY oid;

// Conditional aggregation
SET $AVG2 = AVG(tsr.ds_depth) WHEN tsr.timestep_no >= $i;

// Max/Min with results
SELECT MAX(HDP_table.discharge) INTO $maxQ FROM [Head Discharge];
```

**Formatting:**
- `DP n` - Decimal places for display
- Works with `MIN()`, `MAX()`, `AVG()`, `SUM()`, `COUNT()`

### 15. **String Operations**

```sql
// Concatenation with +
LET $new_id = $us_nodeid + "_" + $chainage;

// String functions
LEN(user_text_1)              // Length
IIF(LEN(user_text_1)=0, '', ',')  // Empty check

// RINDEX - Find rightmost index in list
RINDEX($value, $buckets)      // Returns position in list
```

### 16. **Prompts and User Interaction**

Interactive prompts for user input:

```sql
// Basic prompt
PROMPT TITLE "Define Parameters";
PROMPT LINE $iterations "Number of iterations upstream" DP 3;
PROMPT LINE $min_speed "Minimum assumed average velocity" DP 3;
PROMPT DISPLAY;

// Prompt with list selection
LIST $Surface = "All", "Surface 1", "Surface 2";
PROMPT LINE $SU 'suds_controls.surface' LIST $Surface;
PROMPT DISPLAY;

// Prompt with dynamic list from data
LIST $materials STRING;
SELECT DISTINCT pipe_material INTO $materials;
PROMPT LINE $material 'Material' STRING LIST $materials;
PROMPT DISPLAY;

// Read-only display with OK/Cancel
SELECT COUNT(count(ds_links.*)=1 AND link_suffix>1) INTO $n;
PROMPT TITLE "Press OK to continue or Cancel to review";
PROMPT LINE $n "Number of selected suffix > 1";
PROMPT DISPLAY READONLY;

// String input
PROMPT LINE $MyRoadSelection 'Enter Road Name:' STRING LIST $MyRoad;
```

**Prompt Options:**
- `PROMPT TITLE` - Dialog title
- `PROMPT LINE $var "label"` - Input field
- `PROMPT LINE $var "label" LIST $list` - Dropdown selection
- `PROMPT LINE $var "label" STRING LIST $list` - String list selection
- `PROMPT LINE $var "label" DP n` - Numeric with decimal places
- `PROMPT DISPLAY` - Show dialog
- `PROMPT DISPLAY READONLY` - Show read-only (OK/Cancel)

### 17. **MEMBER Function - List Membership Testing**

Test if a value exists in a list:

```sql
// Define a list of codes
LIST $Mylist = 'CC','CCJ','CL','CLJ','CM','CMJ';

// Select where field value is in the list
SELECT WHERE MEMBER(details.code, $Mylist);

// Use with IF
IF MEMBER($current_value, $valid_values);
    // Value is in list
ENDIF;
```

**MEMBER Rules:**
- Returns true if first argument is found in second argument (list)
- Works with STRING and numeric lists
- Case-sensitive for strings
- Commonly used for filtering based on predefined value sets

### 18. **File I/O Operations**

Load and save data from/to external files:

```sql
// Load list from file
LIST $z STRING;
LOAD $z FROM FILE "C:\TEMP\Variable.txt";

// Save variables to file
SAVE $z, $x1, $y, $y1, $x, $x1 TO FILE 'C:\TEMP\output.txt';

// Use in prompts
LOAD $codes FROM FILE "C:\Data\codes.txt";
PROMPT LINE $code 'Select Code' LIST $codes;
PROMPT DISPLAY;
```

**File I/O Rules:**
- File paths must be quoted strings
- Use absolute paths
- LOAD populates a list variable from file
- SAVE writes multiple variables to file
- Useful for persisting user choices or sharing data

### 19. **Comments**

```sql
// Single line comment (C++ style)

/* Multi-line comment
   Can span multiple lines
   C-style comments */

/* Header comments typically specify object type and spatial search
//Object Type: Node
//Spatial Search: blank
*/
```

### 20. **Table Aliases and Object References**

```sql
// Square brackets for object types
SELECT FROM [All Links];
SELECT FROM [Head Discharge];
UPDATE [All Nodes] SET x = 0;

// Object type references in InfoWorks ICM
[Conduit], [Node], [Subcatchment], [River Reach], [Pump], [Weir], etc.

// Object type references in InfoAsset Manager
[Pipe], [Manhole], [CCTV Survey], [Manhole Survey], etc.
```

### 21. **Working with Survey Data (InfoAsset Manager)**

InfoAsset Manager extends the SQL with survey-specific patterns:

```sql
// Select most recent CCTV survey per pipe
UPDATE SELECTED PIPE SET cctv_surveys.$surveyselection = 1 
WHERE cctv_surveys.when_surveyed = MAX(cctv_surveys.when_surveyed);
SELECT FROM [CCTV Survey] WHERE $surveyselection = 1;

// Filter by survey grades
SELECT WHERE cctv_surveys.structural_grade >= 4;

// Select based on observation codes in blob table
SELECT WHERE MEMBER(details.code, $DefectCodes);

// Insert into survey details
INSERT INTO [Manhole Survey].details (id, details.distance, details.code)
SELECT oid, '0.0', 'MHS' WHERE count(details.code) = 0;

// Delete specific observations
DELETE FROM [CCTV Survey].details 
WHERE details.code <> 'ID' AND details.code <> 'IDJ';
```

### 22. **Common Patterns**

#### Pattern 1: Iterate Through Selected Objects
```sql
LIST $oids STRING;
SELECT DISTINCT oid INTO $oids;
LET $i = 1;
WHILE $i <= LEN($oids);
    LET $current_oid = AREF($i, $oids);
    // Process object
    LET $i = $i + 1;
WEND;
```

#### Pattern 2: Network Tracing (Upstream/Downstream)
```sql
UPDATE [ALL Links] SET $link_selected = 0;
UPDATE [ALL Nodes] SET $node_selected = 0;
UPDATE SELECTED SET $node_selected = 1;

LET $count = 0;
WHILE $count < 3;
    SET us_links.$link_selected = 1 WHERE $node_selected = 1;
    UPDATE [All Links] SET us_node.$node_selected = 1 WHERE $link_selected = 1;
    LET $count = $count + 1;
WEND;

SELECT FROM [All Links] WHERE $link_selected = 1;
```

#### Pattern 3: Populate Node with Connected Links
```sql
UPDATE Node SET user_text_1 = '';
SET ds_node.user_text_1 = ds_node.user_text_1 + 
    IIF(LEN(ds_node.user_text_1)=0, '', ',') + oid;
```

#### Pattern 4: Spatial Query with Cleanup
```sql
SPATIAL NONE;
SELECT ALL FROM [All Nodes];
UPDATE [River reach] SET user_number_1 = 1;
SPATIAL Distance Network [River reach] 100;
SELECT FROM [All Nodes] WHERE spatial.user_number_1 = 1;
SPATIAL NONE;
UPDATE [River reach] SET user_number_1 = "";
```

#### Pattern 5: Expand Selection from Pipe to Related Objects
```sql
// Expand from selected pipes to nodes and surveys
UPDATE SELECTED PIPE SET us_node.$node_sel = 1;
UPDATE SELECTED PIPE SET ds_node.$node_sel = 1;
UPDATE SELECTED PIPE SET cctv_surveys.$survey_sel = 1;

SELECT FROM [Node] WHERE $node_sel = 1;
SELECT FROM [CCTV Survey] WHERE $survey_sel = 1;
```

#### Pattern 6: Conditional Upstream/Downstream Tracing
```sql
LIST $direction = 'Upstream', 'Downstream';
LET $n = 0;

PROMPT TITLE 'Select Direction';
PROMPT LINE $DirectionSelected 'Direction' STRING LIST $direction;
PROMPT LINE $n 'Number of Links' DP 0;
PROMPT DISPLAY;

IF $DirectionSelected = 'Upstream';
    UPDATE [ALL Links] SET $link_selected = 0;
    UPDATE [All Nodes] SET $node_selected = 0;
    UPDATE SELECTED SET $node_selected = 1;
    
    LET $count = 0;
    WHILE $count < $n;
        SET us_links.$link_selected = 1 WHERE $node_selected = 1;
        UPDATE [ALL Links] SET us_node.$node_selected = 1 WHERE $link_selected = 1;
        LET $count = $count + 1;
    WEND;
ELSEIF $DirectionSelected = 'Downstream';
    UPDATE [ALL Links] SET $link_selected = 0;
    UPDATE [All Nodes] SET $node_selected = 0;
    UPDATE SELECTED SET $node_selected = 1;
    
    LET $count = 0;
    WHILE $count < $n;
        SET ds_links.$link_selected = 1 WHERE $node_selected = 1;
        UPDATE [ALL Links] SET ds_node.$node_selected = 1 WHERE $link_selected = 1;
        LET $count = $count + 1;
    WEND;
ENDIF;

SELECT FROM [All Links] WHERE $link_selected = 1;
```

## Important Limitations

### NOT Supported
1. **CASE WHEN** statements - use IF/ELSEIF/ELSE instead
2. **Standard SQL JOINs** - use dot notation navigation instead
3. **Subqueries in WHERE** - use variables and multiple SELECT statements
4. **CREATE TABLE** - objects must exist in network schema
5. **UNION, INTERSECT, EXCEPT** - not available
6. **Window functions** (ROW_NUMBER, RANK, etc.) - not available
7. **DISTINCT ON** - use GROUP BY instead
8. **ALTER TABLE** - schema is fixed
9. **Stored procedures/functions** - SQL is procedural but not extensible
10. **Transactions** (BEGIN, COMMIT, ROLLBACK) - not applicable
11. **FOR loops** - use WHILE loops instead
12. **CONTINUE or BREAK** in loops - not available

### Key Constraints
- **Object type must be specified** in comments at top of script
- **1-indexed arrays** (AREF starts at 1, not 0)
- **Variables must be declared** before use (LET or LIST)
- **Semicolons required** after all statements
- **String concatenation** uses `+` not `||` or `CONCAT()`
- **NULL comparisons** use `= NULL` or `<> NULL` (not IS NULL)
- **No default values** in variable declarations
- **Limited data types** (STRING, INTEGER, FLOAT - inferred)
- **No nested SELECT in WHERE clause** - must use variables

## Best Practices

### 1. Always Specify Object and Spatial Context
```sql
//Object: Conduit
//Spatial Search: blank
```

### 2. Use Descriptive Variable Names
```sql
LET $us_nodeid = $linkid;
LET $distance = 50;
LET $chainage = $distance;
```

### 3. Clean Up After Spatial Queries
```sql
SPATIAL Distance Network [River reach] 100;
// ... perform work ...
SPATIAL NONE;
UPDATE [River reach] SET user_number_1 = "";  // Clean up markers
```

### 4. Initialize Variables Before Loops
```sql
LET $i = 1;
LET $sum = 0;
LET $count = 0;
```

### 5. Use IIF for Simple Conditionals
```sql
// Better than IF block for simple cases
SET value = IIF(condition, true_value, false_value);
```

### 6. Leverage Network Navigation
```sql
// Instead of complex joins, use relationships
SET us_node.user_text = us_node.user_text + oid;
SELECT WHERE all_ds_links.ds_node.node_type = "outfall";
```

### 7. Use DISTINCT with SELECT INTO
```sql
LIST $nodes STRING;
SELECT DISTINCT oid INTO $nodes;  // Avoid duplicates
```

### 8. Comment Complex Logic
```sql
// Calculate pipe vector coordinates
LET $v_x = $x_ds - $x_us;
LET $v_y = $y_ds - $y_us;
```

## Common Field Names

**‚ö†Ô∏è IMPORTANT:** InfoWorks and SWMM networks use **different field names** for the same concepts. For comprehensive, up-to-date field documentation, see the companion guide:

üìò **[InfoWorks_ICM_Database_Fields_Guide.md](InfoWorks_ICM_Database_Fields_Guide.md)**

That guide shows how to navigate Autodesk Help documentation to retrieve accurate field information for:
- InfoWorks network objects
- SWMM network objects  
- InfoAsset Manager objects
- Blob table structures

### Quick Reference - Common Fields

**Universal Fields (All Objects):**
- `oid` - Unique object identifier
- `user_text_1` through `user_text_10` - Custom text fields
- `user_number_1` through `user_number_10` - Custom numeric fields

**InfoWorks Node:**
- `node_id`, `x`, `y`, `ground_level`, `node_type`, `flood_type`, `chamber_floor_level`, `shaft_area`

**SWMM Node (Different!):**
- `node_id`, `x`, `y`, `ground_level`, `maximum_depth`, `initial_depth`, `surcharge_depth`

**InfoWorks Conduit:**
- `us_node_id`, `ds_node_id`, `link_suffix`, `conduit_length`, `conduit_width`, `conduit_height`, `shape`, `material`

**SWMM Conduit (Different!):**
- `us_node_id`, `ds_node_id`, `link_suffix`, `length`, `geom1`, `geom2`, `barrels`, `xsec_type`

**InfoWorks Subcatchment:**
- `subcatchment_id`, `node_id`, `contributing_area`, `area_measurement_type`, `runoff_index`

**SWMM Subcatchment (Different!):**
- `subcatchment_id`, `node_id`, `area`, `width`, `percent_slope`, `percent_imperv`, `n_imperv`, `n_perv`

**Results Fields (InfoWorks ICM):**
- `tsr.timestep_no`, `tsr.timesteps`, `tsr.ds_depth`, `tsr.us_depth`, `tsr.ds_flow`, `tsr.us_flow`, `tsr.us_vel`, `tsr.ds_vel`
- `sim.max_depth`, `sim.max_flow`, `sim.max_Surcharge`

**InfoAsset Manager:**
- `pipe_material` (vs ICM's `material`), `asset_id`, `cctv_surveys.structural_grade`, `details.code`

## SQL Execution Context

### Query Types
1. **Selection queries** - Identify and select objects
2. **Update queries** - Modify object properties
3. **Insert queries** - Create new objects
4. **Delete queries** - Remove objects or blob table rows
5. **Display queries** - Show tabular results with SELECT

### Execution Flow
```sql
// 1. Declare object type and spatial context
//Object: Conduit
//Spatial Search: blank

// 2. Initialize variables
LIST $oids STRING;
LET $i = 1;

// 3. Query and process
SELECT DISTINCT oid INTO $oids;
WHILE $i <= LEN($oids);
    // Process each object
    LET $i = $i + 1;
WEND;

// 4. Final selection or output
SELECT us_node_id, ds_node_id WHERE $selected = 1;
```

## Example Complete SQL Scripts

### Example 1: Simple Selection
```sql
//Object: Conduit
//Spatial Search: blank

// Select conduits with specific properties
SELECT FROM [Conduit] 
WHERE conduit_width >= 300 
AND system_type = 'Foul';
```

### Example 2: Update with Loop
```sql
//Object: Pump
//Spatial Search: blank

LIST $pump_ids STRING;
SELECT DISTINCT oid INTO $pump_ids;

LET $i = 1;
WHILE $i <= LEN($pump_ids);
    LET $pump_id = AREF($i, $pump_ids);
    
    SELECT MAX(HDP_table.discharge) INTO $maxQ 
    FROM [Head Discharge] WHERE oid = $pump_id;
    
    SET user_text_1 = $maxQ WHERE oid = $pump_id;
    
    LET $i = $i + 1;
WEND;
```

### Example 3: Network Tracing
```sql
//Object: All Nodes
//Spatial Search: blank

UPDATE [All Links] SET $link_selected = 0;
UPDATE [All Nodes] SET $node_selected = 0;
UPDATE SELECTED SET $node_selected = 1;

SET all_ds_links.$link_selected = 1 WHERE $node_selected = 1;
SELECT FROM [All Links] WHERE $link_selected = 1;
```

### Example 4: Interactive Prompt
```sql
//Object: Conduit
//Spatial Search: blank

LIST $Dia = 0, 6, 8, 10, 15, 18;
PROMPT TITLE 'Select Diameter Criteria';
PROMPT LINE $DiaSelection 'Minimum Diameter (in):' LIST $Dia;
PROMPT DISPLAY;

SELECT us_node_id, ds_node_id, conduit_width 
WHERE conduit_width >= $DiaSelection;
```

### Example 5: Survey Selection with Aggregation (InfoAsset Manager)
```sql
//Object Type: CCTV Survey
//Spatial Search: blank

// Select most recent survey for each selected pipe
UPDATE SELECTED PIPE SET cctv_surveys.$surveyselection = 1 
WHERE cctv_surveys.when_surveyed = MAX(cctv_surveys.when_surveyed);

SELECT FROM [CCTV Survey] WHERE $surveyselection = 1;
```

### Example 6: Using MEMBER for List Filtering
```sql
//Object Type: CCTV Survey
//Spatial Search: blank

// Define codes of interest
LIST $DefectCodes = 'CC','CCJ','CL','CLJ','CM','CMJ';

// Select surveys containing any of these codes
SELECT WHERE MEMBER(details.code, $DefectCodes);
```

## Summary of Unique Features

InfoWorks ICM SQL is a **domain-specific language** for hydraulic network manipulation with:

1. **Object-oriented** - Operates on network objects, not relational tables
2. **Procedural** - Supports loops, conditionals, variables
3. **Spatial-aware** - Native spatial query operators
4. **Network navigation** - Dot notation for relationship traversal
5. **Results integration** - Direct access to simulation results (ICM only)
6. **Interactive** - Built-in prompt system for user input
7. **Blob tables** - Hierarchical data structures
8. **Selection management** - First-class selection concept
9. **List operations** - MEMBER function for set membership testing
10. **File I/O** - LOAD and SAVE for external data integration

When writing InfoWorks ICM SQL, remember:
- **It's NOT standard SQL** - don't assume SQL Server/PostgreSQL/MySQL syntax
- **Think networks, not databases** - objects are nodes, links, subcatchments
- **Spatial context matters** - understand what you're querying spatially
- **Navigation is powerful** - use dot notation instead of joins
- **Variables are essential** - use them for complex logic
- **Test incrementally** - build queries step by step
- **1-indexed lists** - AREF starts at 1, not 0
- **Use semicolons** - required after every statement
- **No CASE statements** - use IF/ELSEIF/ELSE blocks

## Additional Resources

- [InfoWorks ICM Help - Using SQL](https://help.autodesk.com/view/IWICMS/2026/ENU/?guid=GUID-9C3E4534-B861-4525-920D-D59BE9FEDC6F)
- [SQL in InfoWorks ICM](https://help.autodesk.com/view/IWICMS/2026/ENU/?guid=GUID-F416C0A8-90BC-47F0-9A38-18FBEF65EFB8)